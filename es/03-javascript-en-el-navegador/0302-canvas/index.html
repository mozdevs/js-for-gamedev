
<!DOCTYPE HTML>
<html lang="es" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Canvas · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../03-ejercicios/index.md" />
    
    
    <link rel="prev" href="../0301-dom/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Escribe para buscar" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../01-intro/articulo.md">
            
                <span>
            
                    
                    El entorno de trabajo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    JavaScript básico
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../02-javascript/0201-poo/">
            
                <a href="../../02-javascript/0201-poo/">
            
                    
                    Programación orientada a objetos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../02-javascript/0202-modelo-de-datos/">
            
                <a href="../../02-javascript/0202-modelo-de-datos/">
            
                    
                    El modelo de datos de JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../../02-javascript/0203-modelo-de-ejecucion/">
            
                <a href="../../02-javascript/0203-modelo-de-ejecucion/">
            
                    
                    El modelo de ejecución de JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../../02-javascript/02-ejercicios/">
            
                <a href="../../02-javascript/02-ejercicios/">
            
                    
                    Ejercicios guiados
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../../02-javascript/02-practica/">
            
                <a href="../../02-javascript/02-practica/">
            
                    
                    Práctica
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../../02-javascript/02-practica/GUIDE.html">
            
                <a href="../../02-javascript/02-practica/GUIDE.html">
            
                    
                    Guía
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.2" data-path="../../02-javascript/02-practica/TDD.html">
            
                <a href="../../02-javascript/02-practica/TDD.html">
            
                    
                    TDD
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    JavaScript en el navegador
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../0301-dom/">
            
                <a href="../0301-dom/">
            
                    
                    Navegador y DOM
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.2" data-path="./">
            
                <a href="./">
            
                    
                    Canvas
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../03-ejercicios/index.md">
            
                <span>
            
                    
                    Ejercicios guiados
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../03-practica/">
            
                <a href="../03-practica/">
            
                    
                    Práctica
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.4.1" data-path="../03-practica/guia.html">
            
                <a href="../03-practica/guia.html">
            
                    
                    Guía
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Publicado con GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Canvas</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="canvas">Canvas</h1>
<p>Con la llegada de HTML5, se introdujeron varios elementos HTML y API&apos;s de JavaScript que hacen posible la programaci&#xF3;n de videojuegos con tecnolog&#xED;as y est&#xE1;ndares web, entre ellos el elemento <code>&lt;canvas&gt;</code> y su API JavaScript, que nos permite pintar gr&#xE1;ficos en pantalla, tanto 3D como 2D.</p>
<h2 id="el-elemento-canvas">El elemento <code>&lt;canvas&gt;</code></h2>
<p>Esta etiqueta HTML crea un canvas con el ancho y el alto indicado. Sobre este canvas, podremos dibujar posteriormente usando la API de Canvas.</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;320&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;200&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
</code></pre>
<p>Las <strong>dimensiones</strong> del canvas especificadas en la etiqueta HTML con <code>width</code> y <code>height</code> no tienen por qu&#xE9; corresponderse con las dimensiones en pantalla, sino que se corresponden a una unidad virtual. Por defecto <code>1</code> unidad equivale a <code>1</code> p&#xED;xel, pero con CSS podemos realizar un escalado. Por ejemplo, el siguiente c&#xF3;digo escalar&#xED;a nuestro canvas anterior a un <code>200%</code> del tama&#xF1;o original.</p>
<pre><code class="lang-css"><span class="hljs-selector-tag">canvas</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">640px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">480px</span>;
}
</code></pre>
<p>Podemos usar esto a nuestro favor y jugar con los escalados, o adaptar nuestro juego a distintos tama&#xF1;os de pantalla. Por ejemplo, en este art&#xED;culo se explica c&#xF3;mo usar un escalado para videojuegos retro con pixel art: <a href="https://belenalbeza.com/retro-crisp-pixel-art-in-html-5-games/" target="_blank"><em>Retro, crisp pixel art in HTML5 games</em></a>.</p>
<h2 id="la-api-de-canvas">La API de Canvas</h2>
<p>La API de Canvas nos permite realizar operaciones de dibujo 2D en un elemento <code>&lt;canvas&gt;</code>. Con ella podemos renderizar im&#xE1;genes, manipular p&#xED;xeles, dibujar primitivas gr&#xE1;ficas, curvas, etc.</p>
<p>Dos recursos importantes son:</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" target="_blank">Documentaci&#xF3;n en la MDN</a>.</li>
<li><a href="http://joshondesign.com/p/books/canvasdeepdive/toc.html" target="_blank"><em>Canvas Deep Dive</em></a>: libro online conciso, pero bastante completo.</li>
</ul>
<h3 id="contextos">Contextos</h3>
<p>Para realizar cualquier operaci&#xF3;n de pintado, necesitamos obtener un <strong>contexto 2D</strong> de un <code>&lt;canvas&gt;</code>. Para ello, utilizaremos el m&#xE9;todo <code>getContext</code> y le indicaremos que necesitamos un contexto 2D.</p>
<p>Ejemplo:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> ctx = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&apos;canvas&apos;</span>).getContext(<span class="hljs-string">&apos;2d&apos;</span>);
ctx.fillRect(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
</code></pre>
<p><img src="images/canvas_ex01.png" alt="Screenshot"></p>
<p>Ver el <a href="https://jsfiddle.net/nea366Lm/" target="_blank"><em>snippet</em> de c&#xF3;digo</a> online.</p>
<h3 id="colores-bordes-etc">Colores, bordes, etc.</h3>
<p>La manera de trabajar que tiene la API de Canvas es similar a la de un programa de dibujo. En el <strong>contexto</strong> indicamos los estilos (color de fondo, grosor de borde, etc.) que queremos que las &quot;herramientas&quot; (en este caso, las operaciones de dibujado) usen.</p>
<p>Hay que tener en cuenta que esto tiene &quot;memoria&quot;, y que los estilos se conservan de una operaci&#xF3;n a la siguiente. Es decir, que si establecemos en el contexto que a partir de ahora usaremos el color rojo, <em>todas</em> las operaciones de dibujado posteriores usar&#xE1;n este color, no s&#xF3;lo la siguiente.</p>
<p>Ejemplo:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// red rectangles</span>
ctx.fillStyle = <span class="hljs-string">&apos;#FF004D&apos;</span>;
ctx.fillRect(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
ctx.fillRect(<span class="hljs-number">190</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
<span class="hljs-comment">// blue rect with white border</span>
ctx.fillStyle = <span class="hljs-string">&apos;rgba(41, 173, 255, 0.8)&apos;</span>;
ctx.fillRect(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
ctx.strokeStyle = <span class="hljs-string">&apos;#fff&apos;</span>;
ctx.lineWidth = <span class="hljs-number">5</span>;
ctx.strokeRect(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
</code></pre>
<p><img src="images/canvas_ex02.png" alt="Screenshot"></p>
<p>Ver el <a href="https://jsfiddle.net/x8knv6w3/2/" target="_blank"><em>snippet</em> de c&#xF3;digo</a> online.</p>
<h3 id="im&#xE1;genes">Im&#xE1;genes</h3>
<p>Podemos renderizar im&#xE1;genes en el canvas, pero para ello <strong>deber&#xE1;n cargarse previamente</strong>. El m&#xE9;todo m&#xE1;s trivial es usar una imagen cargada con <code>&lt;img&gt;</code>, pero podemos obtener im&#xE1;genes de otras fuentes: la webcam del usuario, un <code>&lt;video&gt;</code>, otro elemento <code>&lt;canvas&gt;</code>, etc.</p>
<p>Ejemplo:</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;kitten.png&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;A cute kitten&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kitten&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;300&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;300&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
</code></pre>
<pre><code class="lang-javascript"><span class="hljs-built_in">window</span>.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> img = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;kitten&apos;</span>);
    <span class="hljs-keyword">var</span> ctx = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">&apos;canvas&apos;</span>)
        .getContext(<span class="hljs-string">&apos;2d&apos;</span>);

    ctx.drawImage(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
}
</code></pre>
<p>Puedes ver la imagen creada con <code>&lt;img&gt;</code>, y el elemento <code>&lt;canvas&gt;</code> a su lado con la misma imagen dibujada:</p>
<p><img src="images/canvas_ex03.png" alt="Screenshot"></p>
<p>El ejemplo funciona porque el <strong>evento <code>load</code> de <code>window</code></strong> se dispara cuando todas las im&#xE1;genes incluidas en el documento HTML se han cargado, as&#xED; que sabemos con seguridad que est&#xE1; ya disponible para ser pintada en el canvas.</p>
<p>Ver el <a href="https://jsfiddle.net/j4hbb46h/1/" target="_blank"><em>snippet</em> de c&#xF3;digo</a> online.</p>
<h3 id="cargar-im&#xE1;genes-al-vuelo">Cargar im&#xE1;genes al vuelo</h3>
<p>Tener que crear una etiqueta <code>&lt;img&gt;</code> en nuestro HTML por cada imagen que queramos cargar es laborioso. La mayor&#xED;a de motores o librer&#xED;as de videojuegos o gr&#xE1;ficos crean objetos <code>Image</code> din&#xE1;micamente con JavaScript, que no se a&#xF1;aden al DOM &#x2013;por lo que no son visibles.</p>
<p>Los pasos a seguir para cargar una imagen de esta manera ser&#xED;an:</p>
<ol>
<li>Usamos el constructor <strong><code>Image</code></strong>.</li>
<li>Nos subscribimos al evento de <strong><code>load</code></strong> (para pintar la imagen cuando se haya cargado).</li>
<li>Establecemos el atributo <strong><code>src</code></strong> de la imagen para iniciar la carga.</li>
</ol>
<pre><code class="lang-javascript"><span class="hljs-built_in">window</span>.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
    img.addEventListener(<span class="hljs-string">&apos;load&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        ctx.drawImage(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    });
    img.src = <span class="hljs-string">&apos;https://placekitten.com/g/300/300&apos;</span>;
}
</code></pre>
<p><img src="images/canvas_ex04.png" alt="Screenshot"></p>
<p>Ver el <a href="https://jsfiddle.net/Lm56dcb6/" target="_blank"><em>snippet</em> de c&#xF3;digo</a> online.</p>
<h3 id="m&#xE1;s-sobre-la-carga-de-im&#xE1;genes">M&#xE1;s sobre la carga de im&#xE1;genes</h3>
<p>Los elementos <code>&lt;img&gt;</code> que tengan como estilo <code>display:none</code> son invisibles al usuario, pero <em>se siguen cargando</em> igualmente. Es habitual usar esto para ocultar las im&#xE1;genes que se dibujen en el canvas. Como se ha comentado anteriormente, el evento <code>load</code> de <code>window</code> se dispara cuando &#x2013;entre otras cosas&#x2013; todas las im&#xE1;genes del DOM se han cargado, sean visibles o no. Por ello, podemos cargar im&#xE1;genes usando &#xFA;nicamente HTML y CSS, aunque es algo laborioso.</p>
<p>Para cargar im&#xE1;genes desde JavaScript, creando nuevas instancias <code>Image</code>, se suelen utilizar <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank">Promesas</a>, o bien un contador para detectar cu&#xE1;ndo se han cargado todas.</p>
<h3 id="otras-operaciones-de-la-api-de-canvas">Otras operaciones de la API de Canvas</h3>
<p>La API de Canvas es extensa y nos permite hacer muchas otras operaciones, entre ellas:</p>
<ul>
<li>Dibujar curvas y paths complejos</li>
<li>Pintar gradientes</li>
<li><em>Clipping</em></li>
<li>Transformaciones</li>
<li>Manipultar p&#xED;xeles</li>
<li>Etc.</li>
</ul>
<h2 id="webgl">WebGL</h2>
<p>WebGL es una API que nos permite operar con <strong>gr&#xE1;ficos 3D</strong> en un elemento <code>&lt;canvas&gt;</code>. Su filosof&#xED;a es completamente diferente a la API de Canvas, y es una API bastante m&#xE1;s compleja &#x2013;pero potente.</p>
<p>WebGL es una implementaci&#xF3;n en JavaScript de <strong>OpenGL ES 2.0</strong>, que es un est&#xE1;ndar de la industria para el pintado de gr&#xE1;ficos 3D.</p>
<p>Para poder usarla, debemos obtener un <strong>contexto 3D</strong> de un elemento <code>&lt;canvas&gt;</code>. Para ello, debemos especificar el par&#xE1;metro <code>webgl</code> &#x2013;o <code>experimental-webgl</code> en algunos navegadores&#x2013; en la llamada a <code>getContext</code>.</p>
<p>Hay <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API" target="_blank">documentaci&#xF3;n en la MDN</a> sobre esta API.</p>
<h3 id="gr&#xE1;ficos-2d-en-webgl">Gr&#xE1;ficos 2D en WebGL</h3>
<p>En el desarrollo de videojuegos, es habitual utilizar una API de gr&#xE1;ficos 3D tambi&#xE9;n para videojuegos 2D. La raz&#xF3;n no es otra que rendimiento: ciertas operaciones realizadas con gr&#xE1;ficos 3D son m&#xE1;s eficientes, como el <em>Z-ordering</em>, rotaciones, transparencias, etc.</p>
<p>Es posible <strong>simular un mundo 2D</strong> usando una API de gr&#xE1;ficos 3D, como WebGL. El &quot;truco&quot; es utilizar una proyecci&#xF3;n ortogr&#xE1;fica, que no deforme los objetos con la perspectiva. Los gr&#xE1;ficos 2D ser&#xED;an entonces pol&#xED;gonos con una textura dentro de este espacio 2D.</p>
<p>Muchas librer&#xED;as y motores de juegos 2D en JavaScript &#x2013;entre ellos Pixi y Phaser&#x2013; ofrecen la posibilidad de utilizar WebGL como API de gr&#xE1;ficos en lugar de la API de Canvas.</p>
<h3 id="recursos">Recursos</h3>
<p>Para aprender m&#xE1;s sobre WebGL recomendamos los siguientes recursos:</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API" target="_blank">WebGL en la MDN</a>: documentaci&#xF3;n, gu&#xED;as, tutoriales, etc.</li>
<li><em>Introduction to WebGL</em> <a href="https://dev.opera.com/articles/introduction-to-webgl-part-1/" target="_blank">parte 1</a> y <a href="https://dev.opera.com/articles/introduction-to-webgl-part-2-porting-3d/" target="_blank">parte 2</a></li>
<li><a href="http://webglfundamentals.org/" target="_blank"><em>WebGL fundamentals</em></a>: tutoriales paso a paso</li>
</ul>
<h2 id="librer&#xED;as-gr&#xE1;ficas">Librer&#xED;as gr&#xE1;ficas</h2>
<p>Hay dos librer&#xED;as extremadamente populares para el manejo de gr&#xE1;ficos con JavaScript. Son &#xFA;nicamente librer&#xED;as de gr&#xE1;ficos, as&#xED; que no implementan otras funcionalidades necesarias para un videojuego. Sin embargo, constituyen un buen punto de partida bien para desarrollar un motor propio, bien para cuando s&#xF3;lo se necesite pintar gr&#xE1;ficos en un proyecto en concreto.</p>
<p>Muchos motores las utilizan como capa gr&#xE1;fica, as&#xED; que conviene conocerlas si se quiere modificar un motor o acceder a <em>features</em> de estas librer&#xED;as no expuestas por el motor.</p>
<h3 id="gr&#xE1;ficos-2d-pixijs">Gr&#xE1;ficos 2D: Pixi.js</h3>
<ul>
<li><a href="http://www.pixijs.com/" target="_blank">www.pixijs.com</a></li>
<li>Funciona por defecto con WebGL, pero tiene fallback a Canvas 2D.</li>
<li>Phaser utiliza Pixi para renderizar gr&#xE1;ficos</li>
</ul>
<h3 id="gr&#xE1;ficos-3d-threejs">Gr&#xE1;ficos 3D: THREE.js</h3>
<ul>
<li><a href="https://threejs.org/" target="_blank">www.threejs.org</a></li>
<li>Es la librer&#xED;a de referencia para trabajar con WebGL, y simplifica mucho el uso de esta API.</li>
<li>Facilita renderizar gr&#xE1;ficos para ser usados con WebVR (API Web para realidad virtual)</li>
<li>Hay infinidad de tutoriales, libros, etc. disponibles.</li>
</ul>
<h2 id="animaciones">Animaciones</h2>
<p>Hasta ahora hemos visto c&#xF3;mo renderizar gr&#xE1;ficos est&#xE1;ticos en un canvas, pero en un videojuego las im&#xE1;genes est&#xE1;n en movimiento.</p>
<p>En el desarrollo de videojuegos, idealmente vamos a intentar renderizar las im&#xE1;genes en el canvas <strong>60 veces por segundo</strong> (60 FPS o <em>frames per second</em>). Para este cometido <strong>no nos sirven</strong> <code>setTimeout</code> ni <code>setInterval</code>, ya que no son precisas y no tenemos garantizada su ejecuci&#xF3;n (puedes ver las razones <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setTimeout#Reasons_for_delays_longer_than_specified" target="_blank">en la documentaci&#xF3;n</a>).</p>
<p>La manera adecuada para renderizar animaciones en un canvas es usando <code>requestAnimationFrame</code>.</p>
<h3 id="requestanimationframe"><code>requestAnimationFrame</code></h3>
<p>Esta funci&#xF3;n acepta un <em>callback</em> que se llamar&#xE1; autom&#xE1;ticamente la siguiente vez que el navegador <strong><em>pueda</em> pintar</strong> en pantalla. En este <em>callback</em> incluiremos tanto las operaciones de dibujo que queramos realizar, como una nueva llamada a <code>requestAnimationFrame</code>, para establecer as&#xED; un <strong>bucle</strong> continuo.</p>
<p>Ejemplo:</p>
<pre><code class="lang-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>{
    ctx.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.width, canvas.height);
    ctx.fillRect(x, <span class="hljs-number">25</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);
    x = (x + <span class="hljs-number">1</span>) % canvas.width;

    requestAnimationFrame(render);
}

requestAnimationFrame(render);
</code></pre>
<p>Puedes ver una comparaci&#xF3;n del mismo c&#xF3;digo de dibujado ejecut&#xE1;ndose con <code>requestAnimationFrame</code> y con <code>setInterval</code>. Podr&#xE1;s observar que la animaci&#xF3;n con <code>requestAnimationFrame</code> es m&#xE1;s fluida, especialmente si cambias de pesta&#xF1;a en el navegador, lo pasas a segundo plano, etc.</p>
<ul>
<li><a href="https://jsfiddle.net/oxx3h8dp/2/" target="_blank"><em>Snippet</em> de c&#xF3;digo</a> con <code>requestAnimationFrame</code></li>
<li><a href="https://jsfiddle.net/m92kpe4n/2/" target="_blank"><em>Snippet</em> de c&#xF3;digo</a> con <code>setInterval</code></li>
</ul>
<h3 id="tiempo-delta">Tiempo delta</h3>
<p>El <strong>tiempo delta</strong> es como se llama en desarrollo de videojuegos al tiempo que ha transcurrido entre el <em>frame</em> actual y el anterior. Este tiempo es necesario que sea preciso ya que mucha l&#xF3;gica del juego depende de &#xE9;l: animaciones, f&#xED;sicas, etc.</p>
<p>Mientras que en programaci&#xF3;n web se usa normalmente <code>Date</code> para manejar fechas, crear instancias de <code>Date</code> no s&#xF3;lo no es eficiente, sino que estos objetos no tienen la resoluci&#xF3;n suficiente para un videojuego, que necesita decimales de milisegundos.</p>
<p>Existe una alternativa, y es usar objetos de <em>timestamp</em>, <code>DOMHighResTimeStamp</code>, como los que devuelve el uso de la interfaz de <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance" target="_blank"><code>Performance</code></a>. Estos <em>timestamps</em> tienen un margen de error de &#xFA;nicamente 5 microsegundos. Adem&#xE1;s, para nuestra conveniencia, <code>requestAnimationFrame</code> llama a nuestro <strong><em>callback</em> con un <em>timestamp</em></strong>.</p>
<p>En la pr&#xE1;ctica, este par&#xE1;metro nos permite calcular el tiempo delta de forma precisa. El <em>timestamp</em> que optenemos contiene el n&#xFA;mero de milisegundos transcurrido desde la primera llamada a <code>requestAnimationFrame</code>. Si vamos almacenando cu&#xE1;l era el valor del <em>timestamp</em> en el <em>frame</em> anterior, podemos calcular el tiempo delta:</p>
<p>Ejemplo:</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">const</span> SPEED = <span class="hljs-number">60</span>; <span class="hljs-comment">// pixels per second</span>
<span class="hljs-keyword">var</span> oldTimestamp = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">timestamp</span>) </span>{
  <span class="hljs-keyword">var</span> delta = (timestamp - oldTimestamp) / <span class="hljs-number">1000.0</span>;
  oldTimestamp = timestamp;

  <span class="hljs-comment">// ...</span>
  x = (x + SPEED * delta) % canvas.width;
  requestAnimationFrame(render);
}
</code></pre>
<p>Puedes probar el <a href="https://jsfiddle.net/0e11fv91/2/" target="_blank"><em>snippet</em> de c&#xF3;digo</a> online.</p>
<p>Algunas <strong>consideraciones</strong> a tener en cuenta sobre el tiempo delta:</p>
<ul>
<li><p><em>Siempre</em> se ha de poner una <strong>cota superior</strong> al valor del tiempo delta (p.ej: 250ms) para evitar <em>glitches</em> en la l&#xF3;gica del juego. Un &quot;salto&quot; grande en el tiempo delta puede causar fallos en las colisiones, funcionamiento anormal en el motor de f&#xED;sicas, etc.</p>
</li>
<li><p>A veces es recomendable saltarse el <em>update</em> de nuestro juego un <em>frame</em> (por ejemplo, <a href="https://github.com/photonstorm/phaser/blob/master/src/core/Game.js#L784" target="_blank">como hace Phaser</a>).</p>
</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../0301-dom/" class="navigation navigation-prev " aria-label="Previous page: Navegador y DOM">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../03-ejercicios/index.md" class="navigation navigation-next " aria-label="Next page: Ejercicios guiados">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Canvas","level":"1.4.2","depth":2,"next":{"title":"Ejercicios guiados","level":"1.4.3","depth":2,"path":"03-javascript-en-el-navegador/03-ejercicios/index.md","ref":"03-javascript-en-el-navegador/03-ejercicios/index.md","articles":[]},"previous":{"title":"Navegador y DOM","level":"1.4.1","depth":2,"path":"03-javascript-en-el-navegador/0301-dom/index.md","ref":"03-javascript-en-el-navegador/0301-dom/index.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"language":"es","gitbook":"*"},"file":{"path":"03-javascript-en-el-navegador/0302-canvas/index.md","mtime":"2016-11-11T10:28:45.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2016-11-18T14:38:31.682Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

